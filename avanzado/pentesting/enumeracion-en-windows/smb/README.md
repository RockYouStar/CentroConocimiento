# SMB

## Puerto 139

NetBIOS son las siglas de Network Basic Input Output System. Se trata de un protocolo de software que permite a las aplicaciones, los PCs y los ordenadores de sobremesa de una red de área local (LAN) comunicarse con el hardware de la red y transmitir datos a través de ella.&#x20;

Las aplicaciones de software que se ejecutan en una red NetBIOS se localizan e identifican entre sí a través de sus nombres NetBIOS. Un nombre NetBIOS tiene un máximo de 16 caracteres y, normalmente, está separado del nombre del ordenador. Dos aplicaciones inician una sesión NetBIOS cuando una (el cliente) envía un comando para "llamar" a otro cliente (el servidor) a través del puerto TCP 139.

```bash
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```

## Port 445

Mientras que el puerto 139 se conoce técnicamente como "NBT sobre IP", el puerto 445 es "SMB sobre IP". SMB significa 'Server Message Blocks'. El bloque de mensajes de servidor, en lenguaje moderno, también se conoce como sistema común de archivos de Internet. El sistema funciona como un protocolo de red de capa de aplicación que se utiliza principalmente para ofrecer acceso compartido a archivos, impresoras, puertos serie y otros tipos de comunicaciones entre nodos de una red. Por ejemplo, en Windows, SMB puede ejecutarse directamente sobre TCP/IP sin necesidad de NetBIOS sobre TCP/IP. Esto utilizará, como señalas, el puerto 445. En otros sistemas, encontrarás servicios y aplicaciones que utilizan el puerto 139. Esto significa que SMB se ejecuta con NetBIOS sobre TCP/IP.

```bash
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```

## SMB

Server Message Block (SMB) es un protocolo cliente-servidor que regula el acceso a archivos y directorios completos y a otros recursos de red como impresoras, routers o interfaces liberadas para la red. La principal área de aplicación del protocolo ha sido la serie de sistemas operativos Windows en particular, cuyos servicios de red soportan SMB de forma compatible con versiones anteriores, lo que significa que los dispositivos con ediciones más recientes pueden comunicarse fácilmente con los dispositivos que tienen instalado un sistema operativo de Microsoft más antiguo.&#x20;

Con el proyecto de software libre Samba, también existe una solución que permite el uso de SMB en distribuciones de Linux y Unix y, por tanto, la comunicación multiplataforma a través de SMB. Un servidor SMB puede proporcionar partes arbitrarias de su sistema de archivos local como recursos compartidos. Por lo tanto, la jerarquía visible para un cliente es parcialmente independiente de la estructura en el servidor. Los derechos de acceso se definen mediante listas de control de acceso (ACL). Pueden ser controlados de una manera fina basada en atributos tales como ejecutar, leer y acceso completo para usuarios individuales o grupos de usuarios. Las ACL se definen en función de las acciones y, por tanto, no se corresponden con los derechos asignados localmente en el servidor.

## Enumeración del servidor

Escanear una red en busca de hosts:

```bash
nbtscan -r 192.168.0.1/24
```

### Versión del servidor SMB

Para buscar posibles exploits a la versión de SMB es importante saber qué versión se está utilizando. Esto lo podemos hacer con:

\_**auxiliary/scanner/smb/smb\_version**

O con este script:

```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```

Teniendo esto, podemos buscar exploit que apliquen a esa versión de SMB:

```bash
searchsploit microsoft smb
```

